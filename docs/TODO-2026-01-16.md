# TODO â€” 2026-01-16

This checklist tracks the next hardening/polish steps after the Scan backend + camera QR work.

## Now (execute)

- [x] Add DB-backed rate limiting to `POST /api/scan/check-in` (best-effort; skip when service role env missing)
  - Files: `api/scan/check-in.js`, `api/_rateLimit.js`
- [x] Extract shared `bestEffortRateLimit()` helper used by multiple endpoints
  - Files: `api/_rateLimit.js`, `api/routing/{directions,etas}.js`
- [x] Verify: `npm run typecheck && npm run lint && npm run test:run`

## Next (after now)

- [x] Make Scan check-in idempotent/atomic to prevent double-credit on concurrent requests
  - Implemented as a DB unique `dedupe_key` + insert-first semantics in the handler

- [x] Security headers: migrate CSP from `Report-Only` to enforced CSP and remove `'unsafe-eval'`
  - File: `vercel.json`

- [x] Add retention/cleanup for `routing_rate_limits` rows (they accumulate by design due to time-sliced bucket keys)
  - Implemented as `/api/admin/cleanup/rate-limits` + Vercel cron schedule

- [x] Consider extending rate limiting to other high-risk mutations (SoundCloud upload, Shopify import/sync, notifications dispatch)
  - Implemented: SoundCloud upload + Shopify import/sync
